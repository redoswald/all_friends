generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contacts Contact[]
  events   Event[]
  tags     Tag[]
}

model Contact {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name     String
  nickname String?
  notes    String?

  // How you know this person (e.g., "Mom", "College roommate", "Wife's coworker")
  relationship String?

  // Cadence tracking
  cadenceDays  Int?
  snoozedUntil DateTime?
  awayUntil    DateTime? // Contact is away (e.g., traveling) - due date shifts to after return

  // Funnel stage (stored as string: PROSPECT, ACQUAINTANCE, DEVELOPING, ESTABLISHED, CLOSE, DORMANT)
  funnelStage String @default("ACQUAINTANCE")

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tags   ContactTag[]
  events EventContact[]

  // Monica-like features
  fields               ContactField[]
  importantDates       ImportantDate[]
  relationships        ContactRelationship[] @relation("ContactRelationships")
  relatedRelationships ContactRelationship[] @relation("RelatedRelationships")

  @@index([userId])
}

model Tag {
  id     String  @id @default(cuid())
  userId String
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  name  String
  color String?

  contacts ContactTag[]

  @@unique([userId, name])
  @@index([userId])
}

model ContactTag {
  contactId String
  tagId     String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([contactId, tagId])
}

model Event {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title String?
  date  DateTime
  // Event type stored as string: HANGOUT, CALL, MESSAGE, EVENT, OTHER
  eventType String @default("HANGOUT")

  notes String?

  // Calendar integration (Phase 3+)
  externalId     String?
  externalSource String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contacts    EventContact[]
  actionItems ActionItem[]

  @@index([userId])
  @@index([date])
}

model EventContact {
  eventId   String
  contactId String
  event     Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@id([eventId, contactId])
}

model ActionItem {
  id      String @id @default(cuid())
  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  description String
  completed   Boolean   @default(false)
  dueDate     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Contact Fields (email, phone, social media, custom)
model ContactField {
  id        String  @id @default(cuid())
  contactId String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  fieldType String  // EMAIL, PHONE, SOCIAL, CUSTOM
  label     String? // "Work", "Personal", "Mobile", "WhatsApp", etc.
  value     String  // The actual value (email address, phone number, URL, etc.)
  protocol  String? // mailto:, tel:, https://wa.me/, etc.
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([contactId])
}

// Important Dates (birthday, anniversaries, custom)
model ImportantDate {
  id        String  @id @default(cuid())
  contactId String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  dateType String  // BIRTHDAY, ANNIVERSARY, CUSTOM
  label    String? // Custom label like "Wedding Anniversary"
  day      Int     // 1-31
  month    Int     // 1-12
  year     Int?    // Nullable for unknown year

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([contactId])
  @@index([month, day]) // For upcoming date queries
}

// Contact Relationships (bidirectional links between contacts)
model ContactRelationship {
  id String @id @default(cuid())

  contactId String
  contact   Contact @relation("ContactRelationships", fields: [contactId], references: [id], onDelete: Cascade)

  relatedId      String
  relatedContact Contact @relation("RelatedRelationships", fields: [relatedId], references: [id], onDelete: Cascade)

  relationshipType String // SPOUSE, PARTNER, PARENT, CHILD, SIBLING, FRIEND, COLLEAGUE, BOSS

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([contactId, relatedId])
  @@index([contactId])
  @@index([relatedId])
}
